<Page
    x:Class="ConnectionMgr.Views.Pages.ConnectionsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:local="clr-namespace:ConnectionMgr.Views.Pages"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
	xmlns:conv="clr-namespace:ConnectionMgr.Converters"
	xmlns:models="clr-namespace:ConnectionMgr.Models"
    Title="DashboardPage"
    d:DataContext="{d:DesignInstance local:ConnectionsPage,
                                     IsDesignTimeCreatable=False}"
    d:DesignHeight="450"
    d:DesignWidth="800"
    ui:Design.Background="{DynamicResource ApplicationBackgroundBrush}"
    ui:Design.Foreground="{DynamicResource TextFillColorPrimaryBrush}"
    Foreground="{DynamicResource TextFillColorPrimaryBrush}"
	ScrollViewer.CanContentScroll="False"
    mc:Ignorable="d">
	<Page.Resources>
		<conv:ProcessPathToIconConverter x:Key="ExeIconConverter" />
		<conv:PublicIpToFontWeightBoldConverter x:Key="PublicIpAdrToBold"/>
		<BooleanToVisibilityConverter x:Key="BoolToVis"/>

		<DrawingImage x:Key="GrayCirclePlaceholder">
			<DrawingImage.Drawing>
				<DrawingGroup>
					<GeometryDrawing Brush="Gray">
						<GeometryDrawing.Geometry>
							<EllipseGeometry Center="16,16" RadiusX="16" RadiusY="16" />
						</GeometryDrawing.Geometry>
					</GeometryDrawing>
				</DrawingGroup>
			</DrawingImage.Drawing>
		</DrawingImage>
	</Page.Resources>

	<Grid VerticalAlignment="Top">
		<Grid.RowDefinitions>
			<RowDefinition Height="Auto" />
			<RowDefinition Height="*" />
			<RowDefinition Height="Auto" />
		</Grid.RowDefinitions>
		<Grid.ColumnDefinitions>
			<ColumnDefinition Width="*" />
			<ColumnDefinition Width="Auto" />
		</Grid.ColumnDefinitions>

		<!--- Pseudo-Menu -->
		<StackPanel Grid.Row="0"
					Grid.Column="0" Grid.ColumnSpan="1"
					Orientation="Horizontal">
			<ui:Button Content="Refresh"
					   ToolTip="Refresh the List of Connections"
					   Command="{Binding ViewModel.RefreshConnectionCommand}"
					   Icon="{ui:SymbolIcon ArrowClockwise24}" />
			<ui:Button Content="AI Overview"
					   ToolTip="Show details for the current selected connection"
					   Command="{Binding ViewModel.ShowDetailsCommand}"
					   CommandParameter="{Binding ViewModel.CurrentSelection}"
					   Margin="4,0,0,0"
					   Icon="{ui:SymbolIcon DocumentText24}" />
			<ui:DropDownButton Content="Block" 
							   Icon="{ui:SymbolIcon Fire24}"
							   Command="{Binding ViewModel.FirewallDummyCommand}"
							   CommandParameter="{Binding ViewModel.CurrentSelection}"
							   Margin="4,0,0,0">
				<ui:DropDownButton.Flyout>
					<ContextMenu>
						<MenuItem Header="Block connection to IP via hosts entry" 
								  Icon="{ui:SymbolIcon Fire24}"
								  Command="{Binding ViewModel.BlockViaHostFileCommand}"
								  CommandParameter="{Binding ViewModel.CurrentSelection}" />
						<Separator />
						<MenuItem Header="Windows Firewall: Block entire Process" 
								  Icon="{ui:SymbolIcon ShareScreenStop24}"
								  Command="{Binding ViewModel.FirewallBlockProcessCommand}"
								  CommandParameter="{Binding ViewModel.CurrentSelection}" />
						<MenuItem Header="Windows Firewall: Block local Port" 
								  Icon="{ui:SymbolIcon CloudDismiss24}"
								  Command="{Binding ViewModel.FirewallBlockPortCommand}"
								  CommandParameter="{Binding ViewModel.CurrentSelection}" />
					</ContextMenu>
				</ui:DropDownButton.Flyout>
			</ui:DropDownButton>
			<ui:Button Content="End Process"
					   ToolTip="Kill all Processes for the selected executeable"
					   Command="{Binding ViewModel.KillProcessCommand}"
					   CommandParameter="{Binding ViewModel.CurrentSelection}"
					   Margin="4,0,0,0"
					   Icon="{ui:SymbolIcon RecordStop24}" />
			<ui:ProgressRing IsIndeterminate="True"
							 Height="28" Width="28"
							 Margin="36,0,0,0"
							 Visibility="{Binding ViewModel.ShowProgress, Converter={StaticResource BoolToVis}}" />
		</StackPanel>

		<ui:ListView Grid.Row="1"
					 Grid.Column="0" Grid.ColumnSpan="1"
					 HorizontalAlignment="Stretch"
					 VerticalAlignment="Stretch"
					 Width="Auto"
					 Margin="0,12,0,0"
					 ItemsSource="{Binding ViewModel.Connections, Mode=OneWay}"
					 SelectedItem="{Binding ViewModel.CurrentSelection, Mode=TwoWay}"
					 SelectionMode="Single">
			<ui:ListView.ContextMenu>
				<ContextMenu>
					<MenuItem Header="Details" 
						  Icon="{ui:SymbolIcon DocumentText24}"
						  Command="{Binding ViewModel.ShowDetailsCommand}"
						  CommandParameter="{Binding ViewModel.CurrentSelection}" />
					<MenuItem Header="End Process" 
						  Icon="{ui:SymbolIcon RecordStop24}"
						  Command="{Binding ViewModel.KillProcessCommand}"
						  CommandParameter="{Binding ViewModel.CurrentSelection}" />
					<Separator />
					<MenuItem Header="Block connection to IP via hosts entry" 
						  Icon="{ui:SymbolIcon Fire24}"
						  Command="{Binding ViewModel.BlockViaHostFileCommand}"
						  CommandParameter="{Binding ViewModel.CurrentSelection}" />
					<Separator />
					<MenuItem Header="Windows Firewall: Block entire Process" 
						  Icon="{ui:SymbolIcon ShareScreenStop24}"
						  Command="{Binding ViewModel.FirewallBlockProcessCommand}"
						  CommandParameter="{Binding ViewModel.CurrentSelection}" />
					<MenuItem Header="Windows Firewall: Block local Port" 
						  Icon="{ui:SymbolIcon CloudDismiss24}"
						  Command="{Binding ViewModel.FirewallBlockPortCommand}"
						  CommandParameter="{Binding ViewModel.CurrentSelection}" />
				</ContextMenu>
			</ui:ListView.ContextMenu>
			<ui:ListView.ItemTemplate>
				<DataTemplate DataType="{x:Type models:NetworkConnectionInfo}">
					<Grid Margin="8,0">
						<Grid.RowDefinitions>
							<RowDefinition Height="*" />
							<RowDefinition Height="*" />
						</Grid.RowDefinitions>
						<Grid.ColumnDefinitions>
							<ColumnDefinition Width="Auto" />
							<ColumnDefinition Width="2*" />
							<ColumnDefinition Width="2*" />
							<ColumnDefinition Width="*" />
						</Grid.ColumnDefinitions>
						<!-- Image that shows the real exe icon -->
						<Image Width="32" Height="32" Margin="0,8,0,0" Grid.RowSpan="2"
							   Source="{Binding ProcessPath, Converter={StaticResource ExeIconConverter},
											TargetNullValue={StaticResource GrayCirclePlaceholder},
											FallbackValue={StaticResource GrayCirclePlaceholder}}"
							   VerticalAlignment="Center" HorizontalAlignment="Center" />
						<!-- Full process path -->
						<TextBlock Grid.Row="0"
								   Grid.Column="1" Grid.ColumnSpan="4"
								   Margin="12,12,0,0"
								   FontWeight="Bold"
								   HorizontalAlignment="Stretch"
								   TextTrimming="CharacterEllipsis"
								   Text="{Binding NormalizedProcessPath, Mode=OneWay}" />
						<!-- remote IP & port -->
						<StackPanel Grid.Row="1"
									Grid.Column="1"
									Margin="12,6,0,0"
									Orientation="Horizontal">
							<TextBlock VerticalAlignment="Center"
									   FontSize="11"
									   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
									   Text="Remote Socket:" />
							<TextBlock Margin="8,0,0,0"								   
									   FontWeight="{Binding RemoteAddress, Converter={StaticResource PublicIpAdrToBold}}"
									   HorizontalAlignment="Left"
									   VerticalAlignment="Center"
									   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
									   Text="{Binding RemoteConnection, Mode=OneWay}" />
						</StackPanel>
						<!-- local IP & port -->
						<StackPanel Grid.Row="1"
									Grid.Column="2"
									Margin="0,6,0,0"
									Orientation="Horizontal">
							<TextBlock VerticalAlignment="Center"
									   FontSize="11"
									   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
									   Text="Local Socket:" />
							<TextBlock Margin="8,0,0,0"								   
									   HorizontalAlignment="Left"
									   VerticalAlignment="Center"
									   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
									   Text="{Binding LocalConnection, Mode=OneWay}" />
						</StackPanel>
						<!-- protocoll & state -->
						<TextBlock Grid.Row="3"
								   Grid.Column="3"
								   Margin="0,6,12,0"
								   HorizontalAlignment="Right"
								   VerticalAlignment="Center"
								   Foreground="{ui:ThemeResource TextFillColorSecondaryBrush}"
								   Text="{Binding StateProtInfo, Mode=OneWay}" />
					</Grid>
				</DataTemplate>
			</ui:ListView.ItemTemplate>
		</ui:ListView>
	</Grid>
</Page>